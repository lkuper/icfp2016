<!doctype html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <title>visualizer</title>
  <style>
    svg#visualization {
      float: right;
      border: 1px solid #666;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    textarea#theproblem {
      background: #ddd;
    }
  </style>
</head>
<body>

<svg id="visualization" width="400" height="400"></svg>

<p>problem json (clears automatically): <input type="file" class="problem" onchange="readSpec('problem')" /></p>

<p>proposed solution json (optional; doesn&apos;t clear): <input type="file" class="solution" onchange="readSpec('solution')" /></p>

<input type="button" value="clear!" onclick="clear_visualization()" />

<script>

function readSpec(type) {
    contents = "";

    var file = document.querySelector("." + type).files[0];
    var reader = new FileReader();

    reader.addEventListener("load", function() {
        contents = reader.result;
        drawFromJSON(contents, type);
    }, false);

    if (file) {
        reader.readAsText(file);
    }

}

function addLine(point1, point2, color) {
  var svg = document.getElementById("visualization");

  var x1 = point1[0];
  var x2 = point2[0];
  var y1 = -point1[1];
  var y2 = -point2[1];

  var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  line.setAttribute('x1', x1);
  line.setAttribute('y1', y1);
  line.setAttribute('x2', x2);
  line.setAttribute('y2', y2);
  line.setAttribute('stroke', color);
  line.setAttribute('stroke-width', 0.005);
  svg.appendChild(line);
}

function addCircle(point, color) {
  var svg = document.getElementById("visualization");

  console.log(point);

  var x = point[0];
  var y = -point[1];

  var dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  dot.setAttribute('cx', x);
  dot.setAttribute('cy', y);
  dot.setAttribute('r', 0.01);
  dot.setAttribute('stroke', color);
  dot.setAttribute('stroke-width', 0.001);
  dot.setAttribute('fill', color);
  svg.appendChild(dot);
}

function clear_visualization() {
  var svg = document.getElementById("visualization");
  while (svg.firstChild)
    svg.removeChild(svg.firstChild);
}

function adjustViewport(leastright_x, leastup_y, rightest_x, uppest_y) {
    console.log([leastright_x, leastup_y, rightest_x, uppest_y]);
    var viewbox = [leastright_x - 0.01, (-uppest_y) - 0.01,
                   (rightest_x - leastright_x) + 0.02,
                   (uppest_y - leastup_y) + 0.02].join(" ");
    console.log(viewbox);
    var svg = document.getElementById("visualization");
    svg.setAttribute("viewBox", viewbox);
}

function drawFromJSON(jsonString, type) {

    rightest_x = Number.MIN_VALUE;
    uppest_y = Number.MIN_VALUE;
    leastright_x = Number.MAX_VALUE;
    leastup_y = Number.MAX_VALUE;

    if (type === 'problem') {
        clear_visualization();

        problem = JSON.parse(jsonString);
        var skeleton = problem["skeleton"]
        var polygons = problem;
        delete polygons["skeleton"] // destructive!

        // draw skeleton
        for (var i in skeleton) {
            var endpoints = skeleton[i];
            addLine(endpoints[0], endpoints[1], "lightgrey")
        }

        // draw silhouette
        for (var polygon_id in polygons) {
            var points = polygons[polygon_id];

            for (var point in points) {
                x_coord = parseFloat(points[point][0]);
                y_coord = parseFloat(points[point][1]);

                rightest_x = Math.max(x_coord, rightest_x);
                uppest_y = Math.max(y_coord, uppest_y);
                leastright_x = Math.min(x_coord, leastright_x);
                leastup_y = Math.min(y_coord, leastup_y);
            }

            for (var point = 1; point < points.length; point++) {
                addLine(points[point], points[point - 1], "black");
            }
            addLine(points[points.length - 1], points[0], "black");
        }
    }

    if (type === 'solution') {
        solution = JSON.parse(jsonString);
        console.log("the solution");
        console.log(solution);

        for (var i in solution) {
            // console.log("a point")
            addCircle(solution[i], "deepskyblue");
            x_coord = parseFloat(solution[i][0]);
            y_coord = parseFloat(solution[i][1]);

            rightest_x = Math.max(x_coord, rightest_x);
            uppest_y = Math.max(y_coord, uppest_y);
            leastright_x = Math.min(x_coord, leastright_x);
            leastup_y = Math.min(y_coord, leastup_y);
        }
    }

    adjustViewport(leastright_x, leastup_y, rightest_x, uppest_y);
} 

</script>

</body>
</html>
